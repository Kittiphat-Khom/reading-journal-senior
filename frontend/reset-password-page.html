<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <link rel="stylesheet" href="styles/styles.css">
</head>
<body>
    <div class="header-fixed">
        <div class="book-icon"></div>
        <div class="title-text">Welcome to Reading Journal</div>
    </div>

    <div class="form-container">
        <div class="form-title">Reset password</div>
        
        <form id="resetForm" onsubmit="handleResetPassword(event)">
            <input type="hidden" id="token" name="token">

            <div class="input-group">
                <label for="password_r">New Password</label>
                <input type="password" id="password_r" name="password_r" required minlength="6">
            </div>
            <div class="input-group">
                <label for="confirm_password_r">Confirm New Password</label>
                <input type="password" id="confirm_password_r" name="confirm_password_r" required>
            </div>
            
            <div id="error-message" style="color: red; font-size: 12px; margin-bottom: 10px; display: none;"></div>

            <div class="button-group">
                <button type="button" class="button secondary" onclick="navigateTo('log-in-page.html')">Cancel</button>
                <button type="submit" class="button primary">Confirm</button>
            </div>
        </form>
    </div>
    
    <script>
        // เมื่อโหลดหน้าเว็บ ให้ดึง Token จาก URL
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                document.getElementById('token').value = token;
                console.log("Token received.");
            } else {
                // หากไม่มี Token ใน URL ให้แจ้งเตือน หรือ Redirect กลับ
                document.getElementById('error-message').textContent = "Link is invalid or incomplete.";
                document.getElementById('error-message').style.display = "block";
                document.getElementById('resetForm').querySelector('button[type="submit"]').disabled = true;
            }
        }

        function navigateTo(pageUrl) {
            window.location.href = pageUrl;
        }

        async function handleResetPassword(event) {
            event.preventDefault();
            
            const p1 = document.getElementById('password_r').value;
            const p2 = document.getElementById('confirm_password_r').value;
            const token = document.getElementById('token').value;
            const errorMsg = document.getElementById('error-message');
            const submitButton = event.target.querySelector('button[type="submit"]');

            // 1. ตรวจสอบรหัสผ่าน
            if (p1 !== p2) {
                errorMsg.textContent = "Passwords do not match!";
                errorMsg.style.display = "block";
                return;
            }
            if (!token) {
                errorMsg.textContent = "Missing security token.";
                errorMsg.style.display = "block";
                return;
            }

            errorMsg.style.display = "none";
            submitButton.innerText = "Processing...";
            submitButton.disabled = true;

            // 2. ส่งข้อมูลไปยัง Server
            try {
                // ❗️❗️ เปลี่ยน  เป็น URL ของ Server Backend คุณ ❗️❗️
                const response = await fetch('/api/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        token: token, 
                        newPassword: p1 // ส่งรหัสผ่านใหม่
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Password reset successfully!');
                    navigateTo('log-in-page.html');
                } else {
                    errorMsg.textContent = 'Error: ' + data.message;
                    errorMsg.style.display = "block";
                }
            } catch (error) {
                errorMsg.textContent = 'Connection error. Please try again.';
                errorMsg.style.display = "block";
            } finally {
                submitButton.innerText = "Confirm";
                submitButton.disabled = false;
            }
        }
    </script>
</body>
</html>