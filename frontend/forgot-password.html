<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password</title>
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- CSS: Modern Alert Box --- */
        .status-message {
            padding: 12px 15px;
            border-radius: 8px; /* ขอบมน */
            font-size: 0.9rem;
            margin-top: 20px;
            display: none; /* ซ่อนไว้ก่อน */
            text-align: left;
            animation: fadeIn 0.3s ease-out;
        }

        /* สีสำหรับกรณี Error (แดง) */
        .status-message.error {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        /* สีสำหรับกรณี Success (เขียว) */
        .status-message.success {
            background-color: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 1px solid #16a34a;
        }

        /* ไอคอนในกล่องข้อความ */
        .status-message i {
            margin-right: 8px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="header-fixed">
        <div class="book-icon"></div>
        <div class="title-text">Welcome to Reading Journal</div>
    </div>

    <div class="form-container">
        <div class="form-title">Forgot Password</div>
        
        <p style="margin-bottom: 25px; color: #666; font-size: 14px; line-height: 1.6;">
            Enter your email address below, and we'll send you a link to reset your password.
        </p>
        
        <form id="forgotForm" onsubmit="handleEmailSubmit(event)">
            <div class="input-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" required placeholder="">
            </div>

            <div class="button-group">
                <button type="button" class="button secondary" onclick="navigateTo('log-in-page.html')">Back to Login</button>
                <button type="submit" class="button primary">Send Link</button>
            </div>
        </form>
        
        <div id="message" class="status-message"></div>
    </div>
    
    <script>
        function navigateTo(pageUrl) {
            window.location.href = pageUrl;
        }

        async function handleEmailSubmit(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const submitButton = event.target.querySelector('button[type="submit"]');
            const messageDiv = document.getElementById('message');
            
            // 1. Reset UI State
            submitButton.innerText = "Sending...";
            submitButton.disabled = true;
            messageDiv.style.display = 'none';
            messageDiv.className = 'status-message'; // ล้าง class สีเก่าออก

            try {
                // ยิง API (ใช้ path สั้น /api/... เพื่อความชัวร์เรื่อง Port)
                const response = await fetch('/api/forgot-password', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                const data = await response.json();
                
                // --- 2. Force English Logic (ป้องกันภาษาไทยหลุดมาจาก Backend) ---
                let displayMsg = "";
                const serverMsg = (data.message || "").toLowerCase();

                if (response.ok) {
                    // ✅ กรณีสำเร็จ (Success)
                    messageDiv.classList.add('success');
                    // Suggestion ข้อความสำเร็จ
                    displayMsg = "We have sent a password reset link to your email.";
                    
                    // เพิ่ม Icon ถูกต้อง
                    messageDiv.innerHTML = '<i class="fa-solid fa-circle-check"></i> ' + displayMsg;
                } else {
                    // ❌ กรณีไม่สำเร็จ (Error)
                    messageDiv.classList.add('error');
                    
                    // แปลงข้อความ Error เป็นอังกฤษ
                    if (serverMsg.includes("ไม่พบ") || serverMsg.includes("not found")) {
                        displayMsg = "Email address not found.";
                    } else if (/[ก-๙]/.test(serverMsg)) { 
                        // ถ้าเจอภาษาไทยตัวอื่นๆ ให้ใช้ข้อความกลาง
                        displayMsg = "Unable to process request. Please check your email.";
                    } else {
                        // ถ้าเป็นอังกฤษอยู่แล้วก็โชว์เลย
                        displayMsg = serverMsg || "Failed to send reset link.";
                    }
                    
                    // เพิ่ม Icon ตกใจ
                    messageDiv.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> ' + displayMsg;
                }
                
                messageDiv.style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                
                // ❌ กรณีต่อ Server ไม่ได้
                messageDiv.className = 'status-message error';
                messageDiv.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Unable to connect to server. Please try again later.';
                messageDiv.style.display = 'block';
            } finally {
                submitButton.innerText = "Send Link";
                submitButton.disabled = false;
            }
        }
    </script>
</body>
</html>