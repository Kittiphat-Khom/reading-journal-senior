<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Page</title>
  <link rel="stylesheet" href="styles/dashboard-page.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
</head>

<body>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-top">
      <div class="user">
        <div class="avatar"><i class="fa-solid fa-user"></i></div>
        <div class="user-info">
          <div class="user-name" id="user-name">Loading...</div>
          <div class="user-sub" id="user-email">Fetching...</div>
        </div>
        <button class="close-btn" onclick="toggleSidebar()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>

    <div class="sidebar-middle">
      <ul class="menu">
        <li><a href="dashboard-page.html" class="active"><i class="fa-solid fa-book-open"></i>Manage Reading Journals</a></li>
        <li><a href="favorite-page.html"><i class="fa-solid fa-heart"></i>Manage Favorite List</a></li>
        <li><a href="search-page.html"><i class="fa-solid fa-magnifying-glass"></i>Search Book</a></li>
        <li><a href="recommend-page.html"><i class="fa-solid fa-lightbulb"></i>Search Recommended Book</a></li>
        <li><a href="report-bug.html"><i class="fa-solid fa-bug"></i>Bug Report</a></li>
      </ul>
    </div>

    <div class="sidebar-bottom">
      <button class="logout-btn" id="custom-logout-btn" onclick="openLogoutModal(event)">
        <i class="fa-solid fa-right-from-bracket"></i> Log out
      </button>
    </div>
  </aside>

  <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

  <header class="topbar">
    <div class="left">
      <button class="menu-btn" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </button>
      <h1>Manage Reading Journals <span id="total-books" class="header-count"></span></h1>
    </div>
    <div class="actions">
      <button class="action-btn" aria-label="Add" onclick="openJournalPopup()">
        <i class="fa-solid fa-plus"></i>
      </button>
    </div>
  </header>

  <main class="content">
    <div class="container">
      
      <div class="book-grid" id="book-grid"></div>

      <div id="pagination-controls" class="pagination-wrapper" style="display: none;">
        <button id="prev-page-btn" class="page-nav-btn" onclick="changePage(-1)">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
        <span id="page-indicator">Page 1</span>
        <button id="next-page-btn" class="page-nav-btn" onclick="changePage(1)">
            <i class="fa-solid fa-chevron-right"></i>
        </button>
      </div>

      <div id="empty-view" class="empty-view-container" style="display: none;">
        <div class="book-item empty-state" onclick="openJournalPopup()">
           <div class="placeholder-content">
             <i class="fa-solid fa-plus" style="font-size: 3.5rem; margin-bottom: 15px; color: #a0c4d6;"></i>
             <h3>Add your first book</h3>
           </div>
        </div>
      </div>

    </div>
  </main>

  <div id="journalPopup" class="add-modal-overlay">
    <div class="add-modal">
      <button class="add-modal-close" aria-label="‡∏õ‡∏¥‡∏î" onclick="closeJournalPopup()">‚úï</button>
      <iframe id="journalFrame" src=""></iframe>
    </div>
  </div>

  <div id="custom-confirm-modal" class="add-modal-overlay" style="display: none; z-index: 9999;">
      <div class="confirm-box">
          <div class="confirm-icon"><i class="fa-solid fa-circle-exclamation"></i></div>
          <h3>Delete Journal?</h3>
          <p>Are you sure you want to delete this journal?<br>This action cannot be undone.</p>
          <div class="confirm-actions">
              <button id="btn-confirm-cancel" class="btn-secondary">Cancel</button>
              <button id="btn-confirm-yes" class="btn-danger">Delete</button>
          </div>
      </div>
  </div>

  <div id="logoutModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-icon-wrapper">
        <div class="modal-icon">
          <i class="fa-solid fa-power-off"></i>
        </div>
      </div>
      <div class="modal-text-wrapper">
        <h3>Sign Out?</h3>
        <p>Are you sure you want to end your session?</p>
      </div>
      <div class="modal-actions">
        <button id="cancelLogoutBtn" class="btn-secondary" onclick="closeLogoutModal()">Cancel</button>
        <button id="confirmLogoutBtn" class="btn-danger" onclick="confirmLogoutAction()">Yes, Sign Out</button>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
    // ========================================================
    //  üì¶ GLOBAL VARIABLES
    // ========================================================
    let allBooksData = []; 
    let currentPage = 1;   
    const ITEMS_PER_PAGE = 10; 

    // ========================================================
    //  üì¶ UTILITY FUNCTIONS
    // ========================================================
    function formatDate(isoString) {
      if (!isoString) return "Just now";
      const date = new Date(isoString);
      return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function showToast(title, message, type = 'success') {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      let iconClass = type === 'error' ? "fa-circle-exclamation" : (type === 'info' ? "fa-circle-info" : "fa-circle-check");
      
      toast.innerHTML = `
          <div class="toast-icon"><i class="fa-solid ${iconClass}"></i></div>
          <div class="toast-content"><h4>${title}</h4><p>${message}</p></div>
      `;
      container.appendChild(toast);
      setTimeout(() => {
          toast.style.animation = "fadeOutRight 0.5s forwards";
          toast.addEventListener("animationend", () => toast.remove());
      }, 3000);
    }

    // ========================================================
    //  üìö MAIN LOGIC
    // ========================================================

    async function loadJournals() {
      const token = localStorage.getItem("token");
      const grid = document.getElementById("book-grid");
      const totalCountEl = document.getElementById("total-books");
      const paginationEl = document.getElementById("pagination-controls");

      grid.innerHTML = `<p style="color:#555; grid-column: 1/-1; text-align:center;">‚è≥ Loading...</p>`;

      try {
        const res = await fetch("/api/journals", {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        
        allBooksData = await res.json();
        
        if (totalCountEl) {
            totalCountEl.innerHTML = `<i class="fa-solid fa-book-open"></i> Total Books: ${allBooksData.length}`;
        }

        if (!allBooksData || allBooksData.length === 0) {
           paginationEl.style.display = "none";
           renderEmptyState(grid);
           return;
        }

        currentPage = 1;
        renderPage(currentPage);

      } catch (err) {
        console.error("Error loading books:", err);
        grid.innerHTML = `<p style="color:red;">‚ùå Error loading data</p>`;
      }
    }

    function renderPage(page) {
        const grid = document.getElementById("book-grid");
        const paginationEl = document.getElementById("pagination-controls");
        const prevBtn = document.getElementById("prev-page-btn");
        const nextBtn = document.getElementById("next-page-btn");
        const pageInfo = document.getElementById("page-indicator");

        grid.innerHTML = "";

        const totalItems = allBooksData.length + 1; 
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        
        const startIndex = (page - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const booksToShow = allBooksData.slice(startIndex, endIndex);

        if (booksToShow.length === 0) {
            grid.classList.add("center-single-item");
        } else {
            grid.classList.remove("center-single-item");
        }

        booksToShow.forEach(book => {
            const card = createBookCard(book);
            grid.appendChild(card);
        });

        if (booksToShow.length < ITEMS_PER_PAGE) {
             const holder = document.createElement("div");
             holder.className = "book-item placeholder";
             holder.onclick = () => openJournalPopup();
             holder.innerHTML = `
                <div class="placeholder-content">
                    <i class="fa-solid fa-plus placeholder-icon"></i>
                    <h3>Add New Book</h3>
                </div>
            `;
            grid.appendChild(holder);
        }

        if (totalPages > 1) {
            paginationEl.style.display = "flex";
            pageInfo.textContent = `Page ${page} of ${totalPages}`;
            prevBtn.disabled = (page === 1);
            nextBtn.disabled = (page === totalPages);
        } else {
            paginationEl.style.display = "none";
        }
    }

    function changePage(direction) {
        const totalItems = allBooksData.length + 1;
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        const newPage = currentPage + direction;

        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderPage(currentPage);
        }
    }

    function createBookCard(book) {
        const item = document.createElement("div");
        item.className = "book-item";
        item.onclick = () => openJournalPopup(book.id);

        const displayImage = book.book_image || book.image || 'https://placehold.co/150x220?text=No+Image';
        const genre = book.genre && book.genre !== 'unknown-genre' ? book.genre : 'Book';
        const dateStr = formatDate(book.updated_at);

        item.innerHTML = `
            <div class="book-cover-wrapper">
              <img src="${displayImage}" alt="${book.title}" onerror="this.onerror=null; this.src='https://placehold.co/150x220?text=Error';"/>
              <div class="action-overlay">
                  <button class="delete-btn" onclick="deleteJournal(event, ${book.id})">
                    <i class="fa-solid fa-trash"></i>
                  </button>
              </div>
            </div>
            <div class="book-info">
              <h3>${book.title}</h3>
              <p>${book.author || "Unknown Author"}</p>
              <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px;">
                 <span class="genre-badge">${genre}</span>
                 <div class="book-date">
                    <i class="fa-regular fa-clock"></i> Last edited: ${dateStr}
                 </div>
              </div>
            </div>
        `;
        return item;
    }

    function renderEmptyState(grid) {
        grid.innerHTML = "";
        grid.classList.add("center-single-item");
        const holder = document.createElement("div");
        holder.className = "book-item placeholder";
        holder.onclick = () => openJournalPopup();
        holder.innerHTML = `
             <div class="placeholder-content">
               <i class="fa-solid fa-plus placeholder-icon"></i>
               <h3>Add your first book</h3>
             </div>
        `;
        grid.appendChild(holder);
    }

    // ========================================================
    //  üóëÔ∏è DELETE LOGIC
    // ========================================================
    function showConfirm() {
      return new Promise((resolve) => {
        const modal = document.getElementById("custom-confirm-modal");
        const btnYes = document.getElementById("btn-confirm-yes");
        const btnCancel = document.getElementById("btn-confirm-cancel");
        modal.style.display = "flex";
        const handleYes = () => { cleanup(); resolve(true); };
        const handleCancel = () => { cleanup(); resolve(false); };
        const cleanup = () => {
            modal.style.display = "none";
            btnYes.removeEventListener("click", handleYes);
            btnCancel.removeEventListener("click", handleCancel);
        };
        btnYes.addEventListener("click", handleYes);
        btnCancel.addEventListener("click", handleCancel);
      });
    }

    async function deleteJournal(event, id) {
      event.stopPropagation(); 
      const confirmed = await showConfirm(); 
      if (!confirmed) return;

      const token = localStorage.getItem("token");
      try {
        const res = await fetch(`/api/journals/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` }
        });
        if (res.ok) {
          showToast("Success", "Journal deleted successfully", "success");
          loadJournals(); 
        } else {
          showToast("Error", "Failed to delete journal", "error");
        }
      } catch (err) {
        console.error(err);
        showToast("Error", "Server connection failed", "error");
      }
    }

    // ========================================================
    //  üî• LOGOUT LOGIC (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) üî•
    // ========================================================
    window.openLogoutModal = function(event) {
        if(event) { event.preventDefault(); event.stopPropagation(); }
        const modal = document.getElementById("logoutModal");
        if (modal) modal.classList.add("active");
    }

    window.closeLogoutModal = function() {
        const modal = document.getElementById("logoutModal");
        if (modal) modal.classList.remove("active");
    }

    window.confirmLogoutAction = function() {
        const btn = document.getElementById("confirmLogoutBtn");
        if(btn) {
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Signing out...';
            btn.disabled = true;
        }
        setTimeout(() => {
            localStorage.clear();
            window.location.href = "log-in-page.html";
        }, 800);
    }

    window.addEventListener("click", (e) => {
        const modal = document.getElementById("logoutModal");
        if (e.target === modal) closeLogoutModal();
    });

    // ========================================================
    //  üöÄ STARTUP
    // ========================================================
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");
      sidebar.classList.toggle("active");
      overlay.classList.toggle("show");
    }

    function openJournalPopup(bookId) {
      const popup = document.getElementById("journalPopup");
      const frame = document.getElementById("journalFrame");
      popup.classList.add("show");
      frame.src = bookId ? `journal-detail.html?id=${bookId}` : "journal-detail.html";
    }

    function closeJournalPopup() {
      const popup = document.getElementById("journalPopup");
      const frame = document.getElementById("journalFrame");
      popup.classList.remove("show");
      frame.src = "";
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("token");
      if (!token) { window.location.href = "log-in-page.html"; return; }

      try {
        const res = await fetch("/api/users/me", { headers: { Authorization: `Bearer ${token}` } });
        const user = await res.json();
        document.getElementById("user-name").textContent = user.username;
        document.getElementById("user-email").textContent = user.email || "Active user";
      } catch (err) {
        localStorage.removeItem("token");
        window.location.href = "log-in-page.html";
      }

      await loadJournals();
    });
    
    window.addEventListener("message", async (event) => {
      if (event.data === "journalAdded" || event.data === "journalUpdated") {
        closeJournalPopup(); 
        await loadJournals();
        showToast("Saved", "Journal saved successfully", "success");
      }
      if (event.data === "closePopup") {
        closeJournalPopup();
      }
    });
  </script>
</body>
</html>