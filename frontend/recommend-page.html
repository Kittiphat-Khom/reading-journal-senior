<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recommended Books</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="styles/sidebar.css" />
  <link rel="stylesheet" href="styles/recommend.css" />
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    .sort-container {
      display: flex;
      align-items: center;
      background: #fff;
      border: 1px solid #dcdcdc;
      border-radius: 8px;
      padding: 0 10px;
      height: 40px;
      gap: 8px;
      transition: all 0.2s ease;
    }
    .sort-container:hover {
      border-color: #1b6f8e;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .sort-icon {
      color: #666;
      font-size: 0.9rem;
    }
    #sortSelect {
      border: none;
      background: transparent;
      font-family: 'Inter', 'Prompt', sans-serif;
      font-size: 0.9rem;
      color: #333;
      cursor: pointer;
      outline: none;
      padding-right: 5px;
    }
  </style>
</head>
<body>

  <div id="sidebar-container"></div>

  <header class="topbar">
    <div class="left">
      <button class="menu-btn" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </button>
      <h1>Recommended Books</h1>
    </div>
    
    <div class="actions">
      <button class="how-it-works-btn" onclick="openInfoModal()">
        <i class="fa-solid fa-wand-magic-sparkles"></i>
        <span>How AI Works</span>
      </button>

      <div class="sort-container">
        <i class="fa-solid fa-arrow-down-short-wide sort-icon"></i>
        <select id="sortSelect" onchange="handleSortChange(this.value)">
          <option value="az" selected>Title (A-Z)</option>
          <option value="match">Match %</option>
        </select>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="recommendation-wrapper">
        
        <button id="prev-slide" class="nav-circle-btn prev-pos" onclick="prevPage()" disabled>
            <i class="fa-solid fa-chevron-left"></i>
        </button>

        <div class="book-grid" id="book-container">
            <div class="loading-msg">
                <i class="fa-solid fa-spinner fa-spin"></i> Searching for books you may like...
            </div>
        </div>

        <button id="next-slide" class="nav-circle-btn next-pos" onclick="nextPage()">
            <i class="fa-solid fa-chevron-right"></i>
        </button>
    </div>
    
    <div class="page-indicators" id="page-indicators"></div>
  </main>

  <div id="bookModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeBookModal()">&times;</span>
      
      <div class="modal-image-box">
        <img id="modal-img" src="" alt="Book Cover">
      </div>
      
      <h2 id="modal-title" style="margin: 15px 0 5px; color: #222;">Book Title</h2>
      <p id="modal-author" class="author">Author Name</p>
      
      <h4 style="margin: 20px 0 10px; text-align: left; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">Description</h4>
      <p id="modal-desc" class="description">
        No description available.
      </p>
      
      <div class="button-row">
        <button class="add-library-btn" onclick="addToLibrary()">
          <i class="fa-solid fa-plus"></i> Add to Library
        </button>
        <button class="fav-icon-btn" onclick="toggleFavorite(this)">
          <i class="fa-solid fa-heart"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="logoutModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-icon-wrapper">
        <div class="modal-icon">
          <i class="fa-solid fa-power-off"></i>
        </div>
      </div>
      <div class="modal-content-logout"> <div class="modal-text-wrapper">
            <h3>Sign Out?</h3>
            <p>Are you sure you want to end your session?</p>
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancelLogoutBtn" class="btn-cancel" onclick="closeLogoutModal()">Cancel</button>
        <button id="confirmLogoutBtn" class="btn-confirm" onclick="confirmLogoutAction()">Yes, Sign Out</button>
      </div>
    </div>
  </div>

<div id="infoModal" class="info-modal-overlay">
    <div class="info-modal-box">
        <button class="info-close-btn" onclick="closeInfoModal()">&times;</button>
        
        <div class="info-header">
            <div class="info-icon-glow">
                <i class="fa-solid fa-robot"></i>
            </div>
            <h2>How Our AI Recommends</h2>
            <p>Our intelligent system curates the best books for you based on three key factors:</p>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <div class="icon-circle c-blue">
                    <i class="fa-solid fa-brain"></i>
                </div>
                <h4>Deep Content Analysis</h4>
                <p>Our AI "reads" every book summary to understand context and semantic meaning, mimicking human comprehension.</p>
            </div>

            <div class="info-card">
                <div class="icon-circle c-green">
                    <i class="fa-solid fa-fingerprint"></i>
                </div>
                <h4>Personalized Taste</h4>
                <p>The system learns your favorite authors and genres to deliver recommendations that perfectly match your taste.</p>
            </div>

            <div class="info-card">
                <div class="icon-circle c-purple">
                    <i class="fa-solid fa-chart-pie"></i>
                </div>
                <h4>Smart Matching Score</h4>
                <p>We calculate a Match % by combining multiple factors, ensuring results are far more accurate than standard systems.</p>
            </div>
        </div>

        <div class="info-footer">
            <p>The more you read and add to your library, the better the system understands you!</p>
            <button class="btn-got-it" onclick="closeInfoModal()">Got it!</button>
        </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script src="js/layoutsidebar.js"></script>

  <script>
    let allRecommendations = []; 
    let currentPage = 1;
    const itemsPerPage = 10; 
    let currentUserId = null; 
    let currentBookData = null;
    
    // ตัวแปรเก็บสถานะการ Sort (Default: A-Z)
    let currentSortMode = 'az'; 

    async function checkAuth() {
        const userStr = localStorage.getItem("user");
        const token = localStorage.getItem("token");

        if (userStr) {
            try {
                const user = JSON.parse(userStr);
                currentUserId = user.id || user.user_id;
            } catch (e) {}
        }

        if (!token) return;

        try {
            const res = await fetch('/api/users/me', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                const userData = await res.json();
                currentUserId = userData.user_id;
                localStorage.setItem("user", JSON.stringify(userData));
            }
        } catch (err) { console.error(err); }
        
        fetchRecommendations();
    }

    document.addEventListener("DOMContentLoaded", () => {
      checkAuth(); 
    });
    
    // Logout Logic override
    window.openLogoutModal = function(event) {
        if(event) { event.preventDefault(); }
        document.getElementById("logoutModal").classList.add("active");
    }
    window.closeLogoutModal = function() {
        document.getElementById("logoutModal").classList.remove("active");
    }
    window.confirmLogoutAction = function() {
        const btn = document.getElementById("confirmLogoutBtn");
        btn.textContent = "Signing out...";
        btn.disabled = true;
        setTimeout(() => {
            localStorage.clear();
            window.location.href = "log-in-page.html";
        }, 500);
    }

    function showToast(message, type = 'success') {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
        }
        let iconClass = type === 'error' ? 'fa-circle-exclamation' : 'fa-circle-check';
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="fa-solid ${iconClass}"></i><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'slideOutToast 0.4s ease forwards';
            setTimeout(() => toast.remove(), 400); 
        }, 3000);
    }

    async function fetchRecommendations() {
        const container = document.getElementById('book-container');
        const userIdToSend = currentUserId || 1; 
        try {
            const response = await fetch('/api/recommend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userIdToSend })
            });
            if (!response.ok) throw new Error('Server Error');
            const result = await response.json();
            
            if (Array.isArray(result)) allRecommendations = result;
            else if (result.data) allRecommendations = result.data;
            else if (result.recommendations) allRecommendations = result.recommendations;
            else allRecommendations = [];
            
            // เรียกใช้การเรียงลำดับก่อน Render ครั้งแรก
            applySort();

            renderPage(1);

        } catch (error) {
            console.error("Fetch Error:", error);
            container.innerHTML = `<div style="text-align:center; width:100%; grid-column:1/-1; margin-top:50px; color:#666;"><i class="fa-solid fa-triangle-exclamation"></i> Unable to load recommendations.</div>`;
        }
    }

    // ฟังก์ชันรับค่าเมื่อมีการเปลี่ยน Dropdown
    function handleSortChange(mode) {
        currentSortMode = mode;
        applySort();   // เรียงข้อมูลใหม่
        renderPage(1); // รีเซ็ตไปหน้า 1
    }

    // Logic การเรียงลำดับ
    function applySort() {
        if (!allRecommendations || allRecommendations.length === 0) return;

        allRecommendations.sort((a, b) => {
            if (currentSortMode === 'az') {
                // เรียงตามชื่อ A-Z
                const titleA = (a.title || "").toLowerCase();
                const titleB = (b.title || "").toLowerCase();
                if (titleA < titleB) return -1;
                if (titleA > titleB) return 1;
                return 0;
            } else if (currentSortMode === 'match') {
                // เรียงตาม Match % (มากไปน้อย)
                const scoreA = getMatchScore(a);
                const scoreB = getMatchScore(b);
                return scoreB - scoreA; // Descending (มากไปน้อย)
            }
        });
    }

    // Helper แปลงค่า Match เป็นตัวเลข
    function getMatchScore(book) {
        if (book.match_percent) {
            // ตัดเครื่องหมาย % ออกแล้วแปลงเป็นเลข
            return parseFloat(book.match_percent.replace('%', '')) || 0;
        }
        if (book.score !== undefined) {
            // ถ้า score น้อยกว่า 1 (เช่น 0.98) ให้คูณ 100
            return book.score <= 1 ? book.score * 100 : book.score;
        }
        return 0;
    }

function renderPage(page) {
        const container = document.getElementById('book-container');
        if (allRecommendations.length === 0) {
            container.innerHTML = '<div style="text-align:center; width:100%; grid-column:1/-1; margin-top:50px;">No recommendations found.</div>';
            return;
        }

        const totalItems = allRecommendations.length; 
        const totalPages = Math.ceil(totalItems / itemsPerPage);

        if (page < 1) page = 1;
        if (page > totalPages) page = totalPages;
        currentPage = page;

        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const booksToShow = allRecommendations.slice(startIndex, endIndex);

        container.innerHTML = '';
        booksToShow.forEach((book, index) => {
            // 1. คำนวณลำดับ (Rank) 1-100
            const rank = startIndex + index + 1;

            const title = book.title || "Untitled";
            const author = book.authors || "Unknown";
            const reason = book.reason || "Recommended"; 
            let scoreVal = book.score || 0;
            if(scoreVal > 1) scoreVal = scoreVal / 100; 
            const matchText = book.match_percent ? book.match_percent : (scoreVal * 100).toFixed(0) + "%";
            const bgImage = (book.image_url && book.image_url.length > 5) ? book.image_url : 'https://via.placeholder.com/150x220?text=No+Image';
            
            let genreBadges = '';
            let gList = Array.isArray(book.genres) ? book.genres : (book.genres || "").split('|');
            gList.slice(0, 3).forEach(g => { 
                if(g && g.trim().length > 1) genreBadges += `<span class="genre-badge">${g}</span>`; 
            });

            const card = document.createElement('div');
            card.className = 'book-card fade-in-anim';
            card.style.animationDelay = `${index * 0.05}s`;
            card.onclick = () => openBookModal(book);
            
            // 2. แก้ไข HTML: เพิ่ม div class="book-rank" และปรับโครงสร้าง
            card.innerHTML = `
                <div class="book-cover" style="background-image: url('${bgImage}');">
                    <div class="book-rank">#${rank}</div>
                </div>
                <div class="book-info">
                    <h3 class="book-title" title="${title}">${title}</h3>
                    <p class="book-author">by ${author}</p>
                    <div class="book-genres">${genreBadges}</div>
                    <div class="book-footer">
                        <div class="book-reason" title="${reason}">
                            ${reason}
                        </div>
                        <div class="book-score">${matchText} Match</div>
                    </div>
                </div>`;
            
            container.appendChild(card);
        });

        updateNavButtons(totalPages);
        renderDots(totalPages);
    }
    
    function updateNavButtons(totalPages) {
        const prevBtn = document.getElementById('prev-slide');
        const nextBtn = document.getElementById('next-slide');
        
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        
        prevBtn.style.opacity = currentPage === 1 ? "0.5" : "1";
        nextBtn.style.opacity = (currentPage === totalPages || totalPages === 0) ? "0.5" : "1";
    }

    function renderDots(totalPages) {
        const dotsContainer = document.getElementById('page-indicators');
        dotsContainer.innerHTML = '';
        const maxDots = 20; 
        const showDots = Math.min(totalPages, maxDots);

        if(totalPages <= 1) return; 

        for (let i = 1; i <= showDots; i++) {
            const dot = document.createElement('div');
            dot.className = `dot ${i === currentPage ? 'active' : ''}`;
            dot.onclick = () => renderPage(i);
            dotsContainer.appendChild(dot);
        }
    }

    window.prevPage = function() { if (currentPage > 1) renderPage(currentPage - 1); }
    window.nextPage = function() { 
        const totalItems = allRecommendations.length; 
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (currentPage < totalPages) renderPage(currentPage + 1); 
    }

    function openBookModal(book) {
        currentBookData = book; 
        const modal = document.getElementById("bookModal");
        const img = document.getElementById("modal-img");
        const title = document.getElementById("modal-title");
        const author = document.getElementById("modal-author");
        const desc = document.getElementById("modal-desc");
        
        img.src = (book.image_url && book.image_url.length > 5) ? book.image_url : 'https://via.placeholder.com/150x220?text=No+Image';
        title.textContent = book.title || "Untitled";
        author.textContent = book.authors ? `by ${book.authors}` : "Unknown Author";
        desc.textContent = book.description || "This book currently has no description available."; 
        
        const favBtn = document.querySelector('.fav-icon-btn');
        favBtn.classList.remove('active');
        modal.classList.add("active");
    }

    function closeBookModal() {
        document.getElementById("bookModal").classList.remove("active");
    }

    window.onclick = function(event) {
        if (event.target === document.getElementById("bookModal")) closeBookModal();
    }

    // ADD TO LIBRARY
    async function addToLibrary() {
        if (!currentUserId) {
            showToast("Please log in to add books.", "error");
            return;
        }
        if (!currentBookData) return;

        let mainGenre = "General";
        if (currentBookData.genres) {
            if (Array.isArray(currentBookData.genres) && currentBookData.genres.length > 0) {
                mainGenre = currentBookData.genres[0]; 
            } else if (typeof currentBookData.genres === 'string') {
                mainGenre = currentBookData.genres.split('|')[0].trim();
            }
        }

        const payload = {
            user_id: currentUserId,
            title: currentBookData.title || "Untitled",
            author: currentBookData.authors || "Unknown",
            genre: mainGenre,
            book_image: currentBookData.image_url || "",
            description: currentBookData.description || "No description available."
        };

        const addBtn = document.querySelector('.add-library-btn');
        const originalText = addBtn.innerHTML;
        addBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Adding...';
        addBtn.disabled = true;

        try {
            const response = await fetch('/api/journals/add-by-id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (response.ok) {
                showToast(`Added "${payload.title}" to library!`, "success");
                closeBookModal(); 
            } else {
                showToast("Failed: " + (result.error || "Unknown error"), "error");
            }
        } catch (error) {
            console.error("Error adding to library:", error);
            showToast("Network error. Please try again.", "error");
        } finally {
            addBtn.innerHTML = originalText;
            addBtn.disabled = false;
        }
    }

    // TOGGLE FAVORITE
    async function toggleFavorite(btn) {
        if (!currentUserId) {
            showToast("Please log in to manage favorites.", "error");
            return;
        }
        if (!currentBookData) return;

        btn.disabled = true;

        let mainGenre = "General";
        if (currentBookData.genres) {
            if (Array.isArray(currentBookData.genres) && currentBookData.genres.length > 0) {
                mainGenre = currentBookData.genres[0]; 
            } else if (typeof currentBookData.genres === 'string') {
                mainGenre = currentBookData.genres.split('|')[0].trim();
            }
        }

        const payload = {
            user_id: currentUserId,
            title: currentBookData.title || "Untitled",
            author: currentBookData.authors || "Unknown",
            genre: mainGenre,
            book_image: currentBookData.image_url || "",
            description: currentBookData.description || "No description available."
        };

        try {
            const response = await fetch('/api/favorites/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (response.ok) {
                const icon = btn.querySelector('i');
                if (result.status === 'added') {
                    btn.classList.add('active');
                    showToast("Added to Favorites! ❤️", "success");
                } else {
                    btn.classList.remove('active');
                    showToast("Removed from Favorites", "info");
                }
                closeBookModal(); 
            } else {
                showToast("Failed: " + result.error, "error");
            }
        } catch (error) {
            console.error("Error toggling favorite:", error);
            showToast("Network error", "error");
        } finally {
            btn.disabled = false;
        }
    }

    // =========================================
    // ✅ INFO MODAL LOGIC (How AI Works)
    // =========================================
    function openInfoModal() {
        document.getElementById("infoModal").classList.add("active");
    }

    function closeInfoModal() {
        document.getElementById("infoModal").classList.remove("active");
    }

    // ปิดเมื่อคลิกพื้นหลัง (Outside click)
    window.addEventListener('click', function(event) {
        const infoModal = document.getElementById("infoModal");
        // เช็คว่าคลิกโดนพื้นหลัง modal หรือไม่
        if (event.target === infoModal) {
            closeInfoModal();
        }
    });

  </script>
</body>
</html>