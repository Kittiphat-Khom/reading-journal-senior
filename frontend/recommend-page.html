<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recommended Books</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="stylesheet" href="styles/recommend.css" />

  <style>
    #toast-container { position: fixed; top: 90px; right: 20px; z-index: 100000; display: flex; flex-direction: column; gap: 10px; }
    .toast { min-width: 300px; background: #ffffff; padding: 16px 20px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); display: flex; align-items: center; gap: 15px; font-family: 'Inter', sans-serif; font-size: 0.95rem; opacity: 0; transform: translateX(50px); animation: slideInToast 0.4s forwards; border-left: 6px solid #ccc; cursor: pointer; }
    .toast.success { border-left-color: #2ecc71; } .toast.success i { color: #2ecc71; }
    .toast.error { border-left-color: #e74c3c; } .toast.error i { color: #e74c3c; }
    .toast.info { border-left-color: #3498db; } .toast.info i { color: #3498db; }
    .toast i { font-size: 1.4rem; }
    @keyframes slideInToast { to { opacity: 1; transform: translateX(0); } }
    @keyframes slideOutToast { to { opacity: 0; transform: translateX(100%); } }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(3px); justify-content: center; align-items: center; z-index: 20000; }
    .modal.active { display: flex; animation: fadeInModal 0.3s ease; }
    @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { background: #fff; padding: 30px; width: 500px; max-width: 90%; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; position: relative; }
    .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; }
    .modal-image-box img { width: 140px; height: 210px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); margin-bottom: 10px; }
    .fav-icon-btn.active { background: #ff4757; color: white; border-color: #ff4757; }
  </style>
</head>
<body>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-top">
      <div class="user">
        <div class="avatar"><i class="fa-solid fa-user"></i></div>
        <div class="user-info">
          <div class="user-name" id="user-name">Guest</div>
          <div class="user-sub" id="user-email">Please login</div>
        </div>
        <button class="close-btn" onclick="toggleSidebar()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>
    <div class="sidebar-middle">
      <ul class="menu">
        <li><a href="dashboard-page.html"><i class="fa-solid fa-book-open"></i>Manage Reading Journals</a></li>
        <li><a href="favorite-page.html"><i class="fa-solid fa-heart"></i>Manage Favorite List</a></li>
        <li><a href="search-page.html"><i class="fa-solid fa-magnifying-glass"></i>Search Book</a></li>
        <li><a href="recommend-page.html" class="active"><i class="fa-solid fa-lightbulb"></i>Search Recommended Book</a></li>
        <li><a href="report-bug.html"><i class="fa-solid fa-bug"></i>Bug Report</a></li>
      </ul>
    </div>
    <div class="sidebar-bottom">
      <button class="logout-btn" id="logout-btn">
        <i class="fa-solid fa-right-from-bracket"></i> Log out
      </button>
    </div>
  </aside>

  <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

  <header class="topbar">
    <div class="left">
      <button class="menu-btn" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </button>
      <h1>Recommended Books</h1>
    </div>
    <div class="actions">
      <div class="">
        <i class=""></i>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="recommendation-wrapper">
        
        <button id="prev-slide" class="nav-circle-btn prev-pos" onclick="prevPage()" disabled>
            <i class="fa-solid fa-chevron-left"></i>
        </button>

        <div class="book-grid" id="book-container">
            <div class="loading-msg">
                <i class="fa-solid fa-spinner fa-spin"></i> Searching for books you may like...
            </div>
        </div>

        <button id="next-slide" class="nav-circle-btn next-pos" onclick="nextPage()">
            <i class="fa-solid fa-chevron-right"></i>
        </button>
    </div>
    
    <div class="page-indicators" id="page-indicators"></div>
  </main>

  <div id="bookModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeBookModal()">&times;</span>
      
      <div class="modal-image-box">
        <img id="modal-img" src="" alt="Book Cover">
      </div>
      
      <h2 id="modal-title" style="margin: 15px 0 5px; color: #222;">Book Title</h2>
      <p id="modal-author" class="author">Author Name</p>
      
      <h4 style="margin: 20px 0 10px; text-align: left; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">Description</h4>
      <p id="modal-desc" class="description">
        No description available.
      </p>
      
      <div class="button-row">
        <button class="add-library-btn" onclick="addToLibrary()">
          <i class="fa-solid fa-plus"></i> Add to Library
        </button>
        <button class="fav-icon-btn" onclick="toggleFavorite(this)">
          <i class="fa-solid fa-heart"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="logoutModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-icon-wrapper">
        <div class="modal-icon">
          <i class="fa-solid fa-power-off"></i>
        </div>
      </div>
      <div class="modal-content-logout">
        <h3>Sign Out?</h3>
        <p>Are you sure you want to end your session?</p>
      </div>
      <div class="modal-actions">
        <button id="cancelLogoutBtn" class="btn-cancel">Cancel</button>
        <button id="confirmLogoutBtn" class="btn-confirm">Yes, Sign Out</button>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
    let allRecommendations = []; 
    let currentPage = 1;
    const itemsPerPage = 10; 
    let currentUserId = null; 
    let currentBookData = null;

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("active");
      document.getElementById("overlay").classList.toggle("show");
    }

    async function checkAuth() {
        const userStr = localStorage.getItem("user");
        const token = localStorage.getItem("token");

        if (userStr) {
            try {
                const user = JSON.parse(userStr);
                updateUserProfile(user.username || user.name, user.email);
                currentUserId = user.id || user.user_id;
            } catch (e) {}
        }

        if (!token) return;

        try {
            const res = await fetch('/api/users/me', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                const userData = await res.json();
                updateUserProfile(userData.username, userData.email);
                currentUserId = userData.user_id;
                localStorage.setItem("user", JSON.stringify(userData));
            }
        } catch (err) { console.error(err); }
        
        fetchRecommendations();
    }

    function updateUserProfile(name, email) {
        const nameEl = document.getElementById("user-name");
        const emailEl = document.getElementById("user-email");
        if (nameEl) nameEl.textContent = name || "User";
        if (emailEl) emailEl.textContent = email || "";
    }

    document.addEventListener("DOMContentLoaded", () => {
      checkAuth(); 
      
      const logoutBtn = document.getElementById("logout-btn");
      const logoutModal = document.getElementById("logoutModal");
      const cancelBtn = document.getElementById("cancelLogoutBtn");
      const confirmBtn = document.getElementById("confirmLogoutBtn");

      if (logoutBtn && logoutModal) {
          logoutBtn.addEventListener("click", (e) => {
              e.preventDefault();
              logoutModal.classList.add("active");
          });
          cancelBtn.addEventListener("click", () => {
              logoutModal.classList.remove("active");
          });
          logoutModal.addEventListener("click", (e) => {
              if (e.target === logoutModal) logoutModal.classList.remove("active");
          });
          confirmBtn.addEventListener("click", () => {
              confirmBtn.textContent = "Signing out...";
              confirmBtn.disabled = true;
              setTimeout(() => {
                  localStorage.clear();
                  window.location.href = "log-in-page.html";
              }, 500); 
          });
      }
    });

    function showToast(message, type = 'success') {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
        }
        let iconClass = type === 'error' ? 'fa-circle-exclamation' : 'fa-circle-check';
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="fa-solid ${iconClass}"></i><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'slideOutToast 0.4s ease forwards';
            setTimeout(() => toast.remove(), 400); 
        }, 3000);
    }

    async function fetchRecommendations() {
        const container = document.getElementById('book-container');
        const userIdToSend = currentUserId || 1; 
        try {
            const response = await fetch('/api/recommend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userIdToSend })
            });
            if (!response.ok) throw new Error('Server Error');
            const result = await response.json();
            
            if (Array.isArray(result)) allRecommendations = result;
            else if (result.data) allRecommendations = result.data;
            else if (result.recommendations) allRecommendations = result.recommendations;
            else allRecommendations = [];
            
            renderPage(1);

        } catch (error) {
            console.error("Fetch Error:", error);
            container.innerHTML = `<div style="text-align:center; width:100%; grid-column:1/-1; margin-top:50px; color:#666;"><i class="fa-solid fa-triangle-exclamation"></i> Unable to load recommendations.</div>`;
        }
    }

    // ‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Pagination
    function renderPage(page) {
        const container = document.getElementById('book-container');
        if (allRecommendations.length === 0) {
            container.innerHTML = '<div style="text-align:center; width:100%; grid-column:1/-1; margin-top:50px;">No recommendations found.</div>';
            return;
        }

        // üî• Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà 20 ‡πÄ‡∏•‡πà‡∏° (visibleLimit)
        // üî• ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà Backend ‡∏™‡πà‡∏á‡∏°‡∏≤ ‡πÇ‡∏î‡∏¢‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ
        const totalItems = allRecommendations.length; 
        const totalPages = Math.ceil(totalItems / itemsPerPage);

        if (page < 1) page = 1;
        if (page > totalPages) page = totalPages;
        currentPage = page;

        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const booksToShow = allRecommendations.slice(startIndex, endIndex);

        container.innerHTML = '';
        booksToShow.forEach((book, index) => {
            const title = book.title || "Untitled";
            const author = book.authors || "Unknown";
            const reason = book.reason || "Recommended";
            let scoreVal = book.score || 0;
            if(scoreVal > 1) scoreVal = scoreVal / 100; 
            const matchText = book.match_percent ? book.match_percent : (scoreVal * 100).toFixed(0) + "%";
            const bgImage = (book.image_url && book.image_url.length > 5) ? book.image_url : 'https://via.placeholder.com/150x220?text=No+Image';
            
            let genreBadges = '';
            let gList = Array.isArray(book.genres) ? book.genres : (book.genres || "").split('|');
            gList.slice(0, 3).forEach(g => { 
                if(g && g.trim().length > 1) genreBadges += `<span class="genre-badge">${g}</span>`; 
            });

            const card = document.createElement('div');
            card.className = 'book-card fade-in-anim';
            card.style.animationDelay = `${index * 0.05}s`;
            card.onclick = () => openBookModal(book);
            card.innerHTML = `<div class="book-cover" style="background-image: url('${bgImage}');"></div><div class="book-info"><h3 class="book-title" title="${title}">${title}</h3><p class="book-author">by ${author}</p><div class="book-genres">${genreBadges}</div><div class="book-footer"><div class="book-reason" title="${reason}"><i class="fa-solid fa-circle-info"></i> ${reason}</div><div class="book-score">${matchText} Match</div></div></div>`;
            container.appendChild(card);
        });

        updateNavButtons(totalPages);
        renderDots(totalPages);
    }

    function updateNavButtons(totalPages) {
        const prevBtn = document.getElementById('prev-slide');
        const nextBtn = document.getElementById('next-slide');
        
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        
        prevBtn.style.opacity = currentPage === 1 ? "0.5" : "1";
        nextBtn.style.opacity = (currentPage === totalPages || totalPages === 0) ? "0.5" : "1";
    }

    function renderDots(totalPages) {
        const dotsContainer = document.getElementById('page-indicators');
        dotsContainer.innerHTML = '';
        // ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô 20 ‡∏´‡∏ô‡πâ‡∏≤) ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà 5 ‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å‡∏û‡∏≠ ‡∏Å‡∏±‡∏ô UI ‡∏û‡∏±‡∏á
        const maxDots = 8; 
        const showDots = Math.min(totalPages, maxDots);

        if(totalPages <= 1) return; 

        for (let i = 1; i <= showDots; i++) {
            const dot = document.createElement('div');
            dot.className = `dot ${i === currentPage ? 'active' : ''}`;
            dot.onclick = () => renderPage(i);
            dotsContainer.appendChild(dot);
        }
    }

    window.prevPage = function() { if (currentPage > 1) renderPage(currentPage - 1); }
    window.nextPage = function() { 
        const totalItems = allRecommendations.length; 
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (currentPage < totalPages) renderPage(currentPage + 1); 
    }

    // üî• ‡∏•‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ShuffleBooks ‡∏≠‡∏≠‡∏Å

    function openBookModal(book) {
        currentBookData = book; 
        const modal = document.getElementById("bookModal");
        const img = document.getElementById("modal-img");
        const title = document.getElementById("modal-title");
        const author = document.getElementById("modal-author");
        const desc = document.getElementById("modal-desc");
        
        img.src = (book.image_url && book.image_url.length > 5) ? book.image_url : 'https://via.placeholder.com/150x220?text=No+Image';
        title.textContent = book.title || "Untitled";
        author.textContent = book.authors ? `by ${book.authors}` : "Unknown Author";
        desc.textContent = book.description || "This book currently has no description available."; 
        
        const favBtn = document.querySelector('.fav-icon-btn');
        favBtn.classList.remove('active');
        modal.classList.add("active");
    }

    function closeBookModal() {
        document.getElementById("bookModal").classList.remove("active");
    }

    window.onclick = function(event) {
        if (event.target === document.getElementById("bookModal")) closeBookModal();
        if (event.target === document.getElementById("overlay")) toggleSidebar();
    }

    // ‚úÖ ADD TO LIBRARY
    async function addToLibrary() {
        if (!currentUserId) {
            showToast("Please log in to add books.", "error");
            return;
        }
        if (!currentBookData) return;

        let mainGenre = "General";
        if (currentBookData.genres) {
            if (Array.isArray(currentBookData.genres) && currentBookData.genres.length > 0) {
                mainGenre = currentBookData.genres[0]; 
            } else if (typeof currentBookData.genres === 'string') {
                mainGenre = currentBookData.genres.split('|')[0].trim();
            }
        }

        const payload = {
            user_id: currentUserId,
            title: currentBookData.title || "Untitled",
            author: currentBookData.authors || "Unknown",
            genre: mainGenre,
            book_image: currentBookData.image_url || "",
            description: currentBookData.description || "No description available."
        };

        const addBtn = document.querySelector('.add-library-btn');
        const originalText = addBtn.innerHTML;
        addBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Adding...';
        addBtn.disabled = true;

        try {
            const response = await fetch('/api/journals/add-by-id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (response.ok) {
                showToast(`Added "${payload.title}" to library!`, "success");
                closeBookModal(); 
            } else {
                showToast("Failed: " + (result.error || "Unknown error"), "error");
            }
        } catch (error) {
            console.error("Error adding to library:", error);
            showToast("Network error. Please try again.", "error");
        } finally {
            addBtn.innerHTML = originalText;
            addBtn.disabled = false;
        }
    }

    // ‚úÖ TOGGLE FAVORITE
    async function toggleFavorite(btn) {
        if (!currentUserId) {
            showToast("Please log in to manage favorites.", "error");
            return;
        }
        if (!currentBookData) return;

        btn.disabled = true;

        let mainGenre = "General";
        if (currentBookData.genres) {
            if (Array.isArray(currentBookData.genres) && currentBookData.genres.length > 0) {
                mainGenre = currentBookData.genres[0]; 
            } else if (typeof currentBookData.genres === 'string') {
                mainGenre = currentBookData.genres.split('|')[0].trim();
            }
        }

        const payload = {
            user_id: currentUserId,
            title: currentBookData.title || "Untitled",
            author: currentBookData.authors || "Unknown",
            genre: mainGenre,
            book_image: currentBookData.image_url || "",
            description: currentBookData.description || "No description available."
        };

        try {
            const response = await fetch('/api/favorites/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (response.ok) {
                const icon = btn.querySelector('i');
                if (result.status === 'added') {
                    btn.classList.add('active');
                    showToast("Added to Favorites! ‚ù§Ô∏è", "success");
                } else {
                    btn.classList.remove('active');
                    showToast("Removed from Favorites", "info");
                }
                closeBookModal(); 
            } else {
                showToast("Failed: " + result.error, "error");
            }
        } catch (error) {
            console.error("Error toggling favorite:", error);
            showToast("Network error", "error");
        } finally {
            btn.disabled = false;
        }
    }
  </script>
</body>
</html>